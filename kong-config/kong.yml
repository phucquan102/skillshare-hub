_format_version: "3.0"
_transform: true

services:
  # ========================
  # USER SERVICE
  # /api/users  -> user-service:3001 (path gốc '/')
  # ========================
  - name: user-service
    url: http://user-service:3001
    routes:
      - name: user-route
        paths:
          - /api/users
        strip_path: true   # '/api/users/profile' -> '/profile'

  # ========================
  # COURSE SERVICE (courses + admin + upload + students + enrollments)
  # ========================
  - name: course-service
    url: http://course-service:3002
    routes:
      # /api/courses -> course-service root
      - name: course-route
        paths:
          - /api/courses
        strip_path: true   # '/api/courses/123' -> '/123'

  # Admin API: /api/admin/... -> course-service:3002/admin/...
  - name: admin-service
    url: http://course-service:3002/admin
    routes:
      - name: admin-route
        paths:
          - /api/admin
        strip_path: true   # '/api/admin/courses' -> '/courses' (thêm '/admin' từ url service)

  # Upload API: /api/upload -> course-service:3002/upload
  - name: upload-service
    url: http://course-service:3002/upload
    routes:
      - name: upload-route
        paths:
          - /api/upload
        strip_path: true   # '/api/upload/image' -> '/image'

  # Students API: /api/students/... -> course-service:3002/students/...
  - name: student-service
    url: http://course-service:3002/students
    routes:
      - name: student-route
        paths:
          - /api/students
        strip_path: true

  # Enrollments check: /api/enrollments/check -> /enrollments/public/check
  - name: enrollment-check-service
    url: http://course-service:3002/enrollments/public/check
    routes:
      - name: enrollment-check-route
        paths:
          - /api/enrollments/check
        strip_path: true   # không còn phần dư sau /check nên ok

  # Enrollments: /api/enrollments -> /enrollments
  - name: enrollment-service
    url: http://course-service:3002/enrollments
    routes:
      - name: enrollment-route
        paths:
          - /api/enrollments
        strip_path: true

  # ========================
  # PAYMENT SERVICE
  # /api/payments -> payment-service:3003
  # ========================
  - name: payment-service
    url: http://payment-service:3003
    routes:
      - name: payment-route
        paths:
          - /api/payments
        strip_path: true

  # ========================
  # REVIEW SERVICE
  # /api/reviews -> /reviews
  # /api/ratings -> /ratings
  # ========================
  - name: review-service
    url: http://review-service:3005/reviews
    routes:
      - name: review-route
        paths:
          - /api/reviews
        strip_path: true

  - name: rating-service
    url: http://review-service:3005/ratings
    routes:
      - name: rating-route
        paths:
          - /api/ratings
        strip_path: true

  # ========================
  # CHAT SERVICE
  # /api/chat -> chat-service:3004 (gốc '/')
  # /api/notifications -> /notifications
  # /socket.io -> socket.io (WS)
  # ========================
  - name: chat-service
    url: http://chat-service:3004
    routes:
      - name: chat-route
        paths:
          - /api/chat
        strip_path: true   # '/api/chat/...' -> '/...'
        protocols:
          - http
          - https

  - name: notification-service
    url: http://chat-service:3004/notifications
    routes:
      - name: notification-route
        paths:
          - /api/notifications
        strip_path: true

  # WebSocket /socket.io
  - name: chat-ws-service
    url: http://chat-service:3004
    routes:
      - name: chat-ws-route
        paths:
          - /socket.io
        strip_path: false
        protocols:
          - http
          - https
    plugins:
    - name: request-transformer
      config:
        add:
          headers:
            - "X-Forwarded-Proto:http"
    - name: cors
      config:
        origins:
          - http://localhost:8081
          - http://localhost:5173
        methods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        headers:
          - Accept
          - Authorization
          - Content-Type
          - X-Auth-Token
        exposed_headers:
          - Authorization
        credentials: true      

# ========================
# GLOBAL CORS PLUGIN
# ========================
plugins:
  - name: cors
    config:
      origins:
        - http://localhost:8081
        - http://localhost:5173
        - https://app.skillsharehub.com
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Authorization
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - X-Auth-Token
      exposed_headers:
        - Authorization
      credentials: true
      max_age: 3600
